<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Slope maps with GMT</title>
  <meta name="description" content="About two-thirds of dry slab avalanches occur on slopes between 30° and 45° (McClung &amp;amp; Schaerer, 2006). A map of slope angles is therefore a useful tool ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://www.gadom.ski/2017/01/23/slope-maps-with-gmt.html">
  <link rel="alternate" type="application/rss+xml" title="LiDAR :: snow :: ice :: code" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">LiDAR :: snow :: ice :: code</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Slope maps with GMT</h1>
    <p class="post-meta"><time datetime="2017-01-23T00:00:00-07:00" itemprop="datePublished">Jan 23, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>About two-thirds of dry slab avalanches occur on slopes between 30° and 45° <a href="#McClung2006">(McClung &amp; Schaerer, 2006)</a>.
A map of slope angles is therefore a useful tool for safe decision making when backcountry skiing.</p>

<p>The excellent <a href="https://caltopo.com/">CalTopo</a> provides a suite of map building tools, including a slope angle shading map.
But me being me, I want to make my own maps.</p>

<p>This wakthrough describes how to make a slope angle shading map using free and open data and <a href="http://gmt.soest.hawaii.edu/">Generic Mapping Tools (GMT)</a>.
You’ll need the following softwares to follow along:</p>

<ul>
  <li>GMT</li>
  <li><a href="http://www.gdal.org/">GDAL/OGR</a></li>
</ul>

<p>The Makefile used in this example, along with a download script to fetch the map data, are in a gist at the <a href="#conclusion">bottom of this post</a>.</p>

<h2 id="the-goal">The goal</h2>

<p><a href="https://en.wikipedia.org/wiki/Hidden_Valley_(Ski_Estes_Park)">Hidden Valley</a> is a abandoned ski area in Rocky Mountain National Park that closed in 1991.
It now is a popular winter destination for backcountry skiing and sledding.
We want to color-code dangerous slope angles while providing enough additional context to make a useful map.</p>

<p><img src="/img/hidden-valley-slope-angle.png" alt="Hidden Valley" /></p>

<h2 id="getting-the-data">Getting the data</h2>

<p>We’ll use data from the <a href="https://nationalmap.gov/elevation.html">USGS 3D Elevation Program</a> to produce our slope, hillshade, and contour grids.
Our stream and lake overlays will come from the <a href="https://nhd.usgs.gov/">National Hydrography Dataset</a>, and the roads from the <a href="https://catalog.data.gov/dataset/usgs-national-transportation-dataset-ntd-downloadable-data-collectionde7d2">National Transporation Dataset</a>.
All these products are browsable and downloadable through <a href="https://viewer.nationalmap.gov/basic/">The National Map</a>, but here’s direct links to the datasets required for this exercise:</p>

<ul>
  <li><a href="https://prd-tnm.s3.amazonaws.com/StagedProducts/Elevation/13/GridFloat/USGS_NED_13_n40w106_GridFloat.zip">n40w106</a> DEM as GridFloat</li>
  <li><a href="https://prd-tnm.s3.amazonaws.com/StagedProducts/Elevation/13/GridFloat/USGS_NED_13_n41w106_GridFloat.zip">n41w106</a> DEM as GridFloat</li>
  <li><a href="https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/NHD/HU8/HighResolution/Shape/NHD_H_10190005_Shape.zip">Subbasin 10190005</a> as a shapefile</li>
  <li><a href="https://prd-tnm.s3.amazonaws.com/StagedProducts/Tran/Shape/TRAN_8_Colorado_GU_STATEORTERRITORY.zip">Colorado roads</a> as a shapefile</li>
</ul>

<p>All told, it’s about 4.6G of data, organized like this on my system:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ tree -P '*.shp|*.flt'
.
├── dem
│   ├── n40w106
│   │   └── n40w106.shp
│   ├── n41w106
│   │   └── n41w106.shp
│   ├── usgs_ned_13_n40w106_gridfloat.flt
│   └── usgs_ned_13_n41w106_gridfloat.flt
├── roads
│   └── Shape
│       ├── Trans_AirportPoint.shp
│       ├── Trans_AirportRunway.shp
│       ├── Trans_RailFeature.shp
│       ├── Trans_RoadSegment.shp
│       ├── Trans_RoadSegment2.shp
│       ├── Trans_RoadSegment3.shp
│       └── Trans_TrailSegment.shp
└── water
    └── Shape
        ├── NHDArea.shp
        ├── NHDFlowline.shp
        ├── NHDLine.shp
        ├── NHDPoint.shp
        ├── NHDPointEventFC.shp
        ├── NHDWaterbody.shp
        ├── WBDHU10.shp
        ├── WBDHU12.shp
        ├── WBDHU2.shp
        ├── WBDHU4.shp
        ├── WBDHU8.shp
        └── WBDLine.shp

7 directories, 23 files
</code></pre>
</div>

<h2 id="creating-a-simple-raster-map-with-gmt">Creating a simple raster map with GMT</h2>

<p>To prove that our system is working, let’s create a rainbow elevation map from our DEM data in our area of interest.
We’ll use a Makefile and place our generated products in <code class="highlighter-rouge">build/</code>.</p>

<p>First, we define our area of interest and create a rule for our build directory:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>XMIN:=-105.70
XMAX:=-105.62
YMIN:=40.37
YMAX:=40.41

build:
	mkdir $@
</code></pre>
</div>

<p>Next, we subset our DEM data to our area of interest using a VRT.
For some reason GMT (on my system) isn’t happy reading VRTs, even though it should be able to use any GDAL-y data source, so we use the VRT to create a GeoTIFF:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>build/dem.vrt: Makefile | build
	gdalbuildvrt -te $(XMIN) $(YMIN) $(XMAX) $(YMAX) $@ $(wildcard dem/*.flt)

build/dem.tif: build/dem.vrt
	gdal_translate $&lt; $@
</code></pre>
</div>

<p>Finally, we create our simple rainbow elevation map.
I do this in two steps — first I create the PostScript file, then I use <code class="highlighter-rouge">psconvert</code> to turn it into a png:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>build/hidden-valley.ps: build/dem.tif Makefile | build
	grdimage $&lt; &gt; $@

%.png: %.ps
	psconvert -TG -A -P $&lt;
</code></pre>
</div>

<p>A few things to note:</p>

<ol>
  <li><code class="highlighter-rouge">grdimage</code> takes <em>many</em> more options, but for now we’re keeping it simple.</li>
  <li>The <code class="highlighter-rouge">psconvert</code> command converts the PostScript file into a png with transparency (<code class="highlighter-rouge">-TG</code>), cropped (<code class="highlighter-rouge">-A</code>), and rotated into portrait mode (<code class="highlighter-rouge">-P</code>).</li>
</ol>

<p>We make our map by running <code class="highlighter-rouge">make build/hidden-valley.png</code>:</p>

<p><img src="/img/hidden-valley-rainbow.png" alt="Rainbow elevation map of Hidden Valley" /></p>

<h2 id="creating-more-derivative-products">Creating more derivative products</h2>

<p>We’ve already created one derivative product, our cropped DEM <code class="highlighter-rouge">build/dem.tif</code>.
Let’s create the rest of the products we need to make our map.
I’ll step through the rules one-by-one and talk through what they’re doing.</p>

<h3 id="calculate-the-slope">Calculate the slope</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>build/slope.nc: build/dem.tif
	grdgradient -fg $&lt; -S$@ -D
	grdmath $@ ATAN PI DIV 180 MUL = $@
</code></pre>
</div>

<p><code class="highlighter-rouge">grdgradient</code> does derivative math on gridded data.
In this case, we use the combination of the <code class="highlighter-rouge">-D</code> and <code class="highlighter-rouge">-S</code> options to write the magnitude of the gradient vector to a file, <code class="highlighter-rouge">build/slope.nc</code>.
We also need to specify <code class="highlighter-rouge">-fg</code> because our data is a geographic (lat/lon) grid and we need to convert those latitudes and longitudes to meters before calculating the gradient.
Once we’ve calculated the raw gradient magnitude, we convert that scalar value to an angle, in degrees, using <code class="highlighter-rouge">grdmath</code>.</p>

<h3 id="create-a-hillshade">Create a hillshade</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>build/gradient.nc: build/dem.tif
	grdgradient -fg $&lt; -G$@ -A-45 -Nt0.6
</code></pre>
</div>

<p>In this case, we use <code class="highlighter-rouge">grdgradient</code> to create a hillshade.
We use <code class="highlighter-rouge">-N</code> to control the intensity of the hillshade — since we’ll be drawing contours and additional overlays, we dial down the intensity to <code class="highlighter-rouge">0.6</code> so the map is a bit less noisy.</p>

<h3 id="crop-and-convert-the-vector-data">Crop and convert the vector data</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>OGR2GMT:=ogr2ogr -f GMT -spat $(XMIN) $(YMIN) $(XMAX) $(YMAX) -clipsrc spat_extent

build/flowline.gmt: water/Shape/NHDFlowline.shp
	$(OGR2GMT) $@ $&lt; 

build/waterbody.gmt: water/Shape/NHDWaterbody.shp
	$(OGR2GMT) $@ $&lt; 

build/roads.shp: $(wildcard roads/Shape/Trans_RoadSegment*.shp)
	ogr2ogr -f 'ESRI Shapefile' -spat $(XMIN) $(YMIN) $(XMAX) $(YMAX) -clipsrc spat_extent $@ $(word 1,$^)
	ogr2ogr -f 'ESRI Shapefile' -spat $(XMIN) $(YMIN) $(XMAX) $(YMAX) -clipsrc spat_extent -addfields $@ $(word 2,$^)
	ogr2ogr -f 'ESRI Shapefile' -spat $(XMIN) $(YMIN) $(XMAX) $(YMAX) -clipsrc spat_extent -addfields $@ $(word 3,$^)

build/roads.gmt: build/roads.shp
	ogr2ogr -f GMT $@ $&lt;
</code></pre>
</div>

<p>Creating flowline (streams) and waterbody (lakes, etc) vectors is a simple matter of cropping the source data with <code class="highlighter-rouge">ogr2ogr</code> and writing it out in the GMT format.
Creating the roads file is a bit more tricky, since the road data comes in three seperate shapefiles.
I wasn’t able to figure out how to <code class="highlighter-rouge">-addfields</code> to a GMT vector file, so I create an intermediate <code class="highlighter-rouge">build/roads.shp</code>, then convert that file to gmt.</p>

<h3 id="create-a-color-palette">Create a color palette</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>build/slope.cpt: Makefile
	makecpt -Cwhite,'#ffff33','#ff7f00','#e41a1c','#984ea3','#377eb8','#777777' -T0,25,30,35,40,45,50,90 -N &gt; $@
</code></pre>
</div>

<p>This rule creates a color palette that we’ll use for our slopes.</p>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>Now that we’ve created all of the intermediate products, let’s rewrite our PostScript rule to create our final map.
I’ll step through the rule components one-by-one, with an explanation immediately after.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>build/hidden-valley.ps: build/dem.tif build/slope.nc build/gradient.nc build/flowline.gmt build/waterbody.gmt build/roads.gmt build/slope.cpt Makefile
</code></pre>
</div>

<p>Add all of our derivative products to ensure they get built.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>	grdimage build/slope.nc -Cbuild/slope.cpt -Ibuild/gradient.nc -Ba -B+t"Hidden Valley" -JM8i -Rbuild/slope.nc -K &gt; $@
</code></pre>
</div>

<p>Draw the slope grid, colored with our custom palette.
The <code class="highlighter-rouge">-JM8i</code> specifies the projection for these data, in this case a Mercator projection that is 8 inches wide.
The <code class="highlighter-rouge">-R</code> instructs <code class="highlighter-rouge">grdimage</code> to use the bounds of the <code class="highlighter-rouge">build/slope.nc</code> grid as the bounds of the plot.
The <code class="highlighter-rouge">-I</code> option adds the hillshade, the <code class="highlighter-rouge">-Ba</code> adds a border, the <code class="highlighter-rouge">-B+t</code> titles the plot.
The <code class="highlighter-rouge">-K</code> option “keeps the output file open” so we can add more layers.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>	grdcontour build/dem.tif -C20 -A100 -J -R -K -O &gt;&gt; $@
</code></pre>
</div>

<p>Add contours spaced 20 meters apart, labelled every 100 meters.
The <code class="highlighter-rouge">-J</code> and <code class="highlighter-rouge">-R</code> options inherit the values used in the previous command, so we don’t need to specify them again.
The <code class="highlighter-rouge">-O</code> option instructs <code class="highlighter-rouge">grdcontour</code> to output “overlay” PostScript that is meant to be appended onto PostScript data “kept open” with <code class="highlighter-rouge">-K</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>	psxy build/flowline.gmt -W0.6p,'#377eb8' -J -R -K -O &gt;&gt; $@
	psxy build/waterbody.gmt -G'#377eb8' -J -R -K -O &gt;&gt; $@
	psxy build/roads.gmt -W1p,'#f781bf' -J -R -K -O &gt;&gt; $@
</code></pre>
</div>

<p>Add the vector data.
The <code class="highlighter-rouge">-W</code> option specifies the pen used to draw lines, and the <code class="highlighter-rouge">-G</code> option specifies the fill.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>	psbasemap -Lx5.2i/-0.7i+c$(YMIN)+w1k -J -R -K -O &gt;&gt; $@
</code></pre>
</div>

<p>Add the length scale, set to 1km.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>	psscale -D0i/-0.7i+w3i/0.2i+h -Cbuild/slope.cpt -G0/60 -By+l"Slope angle" -I -O &gt;&gt; $@
</code></pre>
</div>

<p>Add the color legend.</p>

<p>Now you can run <code class="highlighter-rouge">make build/hidden-valley.png</code> and get your map!</p>

<p><img src="/img/hidden-valley-slope-angle.png" alt="Hidden Valley" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>By automating this map-generation, you can easily create maps for new areas.
I’ve souped up this example into <a href="https://github.com/gadomski/slope-maps">this project</a>, which I can use to quickly create maps of new areas I’m exploring.</p>

<p>Here’s the complete Makefile used for this example, along with a download script to grab the data you need:</p>

<script src="https://gist.github.com/gadomski/f90e464114e5bbfecdda9e6b262f5adf.js"> </script>

<h2 id="references">References</h2>

<ol class="bibliography"><li><span id="McClung2006">McClung, D., &amp; Schaerer, P. (2006). <i>The Avalanche Handbook</i> (3rd ed.). The Mountaineers Books.</span></li></ol>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">LiDAR :: snow :: ice :: code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              LiDAR :: snow :: ice :: code
            
            </li>
            
            <li><a href="mailto:pete@gadom.ski">pete@gadom.ski</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/gadomski"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">gadomski</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/petegadomski"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">petegadomski</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>I do research, code development, and field work for CRREL.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
